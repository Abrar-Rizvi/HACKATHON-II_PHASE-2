---
id: 005
title: Secure FastAPI JWT Authentication
stage: spec
date: 2026-01-16
surface: agent
model: claude-sonnet-4-5-20250929
feature: jwt-auth-backend
branch: 001-jwt-auth-backend
user: claude
command: sp.specify
labels: [authentication,jwt,fastapi,security]
links:
  spec: ./specs/001-jwt-auth-backend/spec.md
  ticket: null
  adr: null
  pr: null
files:
 - specs/001-jwt-auth-backend/spec.md
 - specs/001-jwt-auth-backend/checklists/requirements.md
tests:
 -
---

## Prompt

Title: Secure FastAPI Backend with JWT-Based Authentication

Goal:
Secure all FastAPI backend endpoints using JWT authentication issued by Better Auth, ensuring only authenticated users can access the API.

Target system:
Python FastAPI backend for a full-stack Todo application.

Focus:
- JWT verification
- Stateless authentication
- Reliable user identity extraction for downstream authorization

Success criteria:
- All protected endpoints require a valid JWT token
- Requests without a token return 401 Unauthorized
- Requests with invalid or expired tokens return 401 Unauthorized
- Authenticated user identity (user_id, email) is reliably available in request context
- Backend remains stateless (no sessions, no frontend calls)
- JWT verification uses shared BETTER_AUTH_SECRET
- OpenAPI documentation reflects authentication requirements

Scope (What to build):
- JWT verification utility or middleware in FastAPI
- Authorization header parsing (`Authorization: Bearer <token>`)
- JWT signature verification using shared secret
- Token expiry validation
- Token payload decoding (user_id, email)
- Dependency or middleware to inject authenticated user into request context
- Standardized auth error responses (401 / 403)

Includes:
- Environment variable usage (BETTER_AUTH_SECRET)
- Algorithm selection compatible with Better Auth JWTs
- Clear separation of auth logic from business logic
- Reusable dependency/middleware for future routes

Constraints:
- Backend only (no frontend changes)
- Use Python FastAPI best practices
- No database calls for authentication
- Stateless JWT verification only
- No task ownership logic yet (handled in Spec-4)
- No refresh token implementation
- No role-based access control (RBAC)

Not building:
- User signup/signin endpoints
- Token issuance logic (handled by Better Auth in Spec-2)
- Task filtering by user (Spec-4)
- Session-based authentication
- OAuth providers or social login

Acceptance checks:
- API rejects unauthenticated requests
- API accepts valid JWT tokens generated by Better Auth
- Decoded user_id matches expected payload format
- Token expiry is enforced
- Auth logic is testable and reusable

Outcome:
A fully secured FastAPI backend that only accepts authenticated requests, exposes user identity safely to route handlers, and is ready for user-level authorization in the next spec.




/sp.plan

Create:
- JWT verification architecture sketch (middleware vs dependency)
- Auth flow diagram: Request ‚Üí Header ‚Üí JWT Decode ‚Üí User Context
- Section structure for implementation steps

Decisions needing documentation:
- Middleware vs dependency injection (tradeoffs)
- JWT library choice (e.g., python-jose vs PyJWT)
- Error handling strategy (401 vs 403)
- Token payload contract assumptions

Testing strategy:
- Missing Authorization header ‚Üí 401
- Invalid signature ‚Üí 401
- Expired token ‚Üí 401
- Valid token ‚Üí user context available
- OpenAPI security scheme visible

Technical approach:
- Stateless JWT verification
- Shared secret via BETTER_AUTH_SECRET
- FastAPI dependency injection
- No DB calls during auth
- Build incrementally and validate per endpoint

## Response snapshot

I have successfully created a comprehensive specification for securing the FastAPI backend with JWT-based authentication. The specification includes:

1. Detailed user scenarios with priorities (P1-P3)
2. Clear acceptance scenarios in Given/When/Then format
3. Identified edge cases for robust implementation
4. 10 specific functional requirements (FR-001 to FR-010)
5. Key entities definitions (JWT Token and Authenticated User Context)
6. 6 measurable success criteria (SC-001 to SC-006)

The spec follows all requirements by focusing on WHAT the system must do rather than HOW to implement it, ensuring it's technology-agnostic and focused on user value. I've also created a quality checklist that confirms all validation items pass.

## Outcome

- ‚úÖ Impact: Created complete JWT authentication spec for FastAPI backend with detailed requirements, user scenarios, and success criteria
- üß™ Tests: Specification includes testable acceptance scenarios for each user story
- üìÅ Files: Created spec.md and requirements checklist in specs/001-jwt-auth-backend/
- üîÅ Next prompts: Ready for /sp.plan to design the implementation architecture
- üß† Reflection: Specification successfully abstracts implementation details while defining clear security requirements

## Evaluation notes (flywheel)

- Failure modes observed: None - all validation checklist items passed
- Graders run and results (PASS/FAIL): PASS - Specification meets all quality criteria
- Prompt variant (if applicable): N/A
- Next experiment (smallest change to try): Proceed with architectural planning for JWT implementation